<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ma Gazette du Matin</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg-color: #121212;
      --card-color: #1e1e1e;
      --text-color: #e0e0e0;
      --accent-color: #4fc3f7;
      --button-bg: #2a2a2a;
      --button-hover: #3d3d3d;
    }
    body {
      margin: 0;
      font-family: 'Space Mono', monospace;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
    }
    h1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 2em;
      margin-bottom: 20px;
      color: var(--accent-color);
      gap: 1em;
    }
    #date {
      font-size: 0.8em;
      color: var(--text-color);
      margin-left: 10px;
      white-space: nowrap;
    }
    button {
      background-color: var(--button-bg);
      border: none;
      color: var(--accent-color);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background-color: var(--button-hover);
    }
    .section {
      background-color: var(--card-color);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    .section h2 {
      margin-top: 0;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5em;
      color: var(--accent-color);
    }
    .logs {
      font-family: 'Space Mono', monospace;
      font-size: 0.9em;
      color: #aaa;
      background-color: #222;
      padding: 10px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-line;
    }
    .error {
      color: #f44336;
      font-weight: bold;
      white-space: normal;
    }
    a {
      color: var(--accent-color);
      text-decoration: underline;
      word-break: break-word;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.5em;
        flex-direction: column;
        align-items: flex-start;
        gap: 0;
      }
      .section {
        padding: 10px;
      }
      button {
        padding: 6px 12px;
        font-size: 0.9em;
      }
      .section h2 {
        font-size: 1.2em;
      }
      #date {
        margin-left: 0;
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>
  <h1>
    üì¨ Ma Gazette du Jour
    <span id="date"></span>
    <button onclick="manualRefresh()">üîÑ Rafra√Æchir</button>
  </h1>

  <div id="gazette">Chargement...</div>
  <div id="logs" class="logs"></div>

  <script>
    const MISTRAL_API_KEY = "4TkJgrGZ19tSwyrRPqYUqgAZh4ttCKmc";
    const weatherCodes = {0:"Ciel clair",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",61:"Pluie faible",95:"Orages"};

    function updateDateDisplay() {
      const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
      const today = new Date();
      const formattedDate = today.toLocaleDateString("fr-FR", options);
      document.getElementById("date").innerText = formattedDate;
      // Date format jour mois ann√©e pour prompt (ex: "22 ao√ªt 2025")
      return today.toLocaleDateString("fr-FR", {day: "numeric", month: "long", year: "numeric"});
    }

    function log(msg){
      const logs = document.getElementById("logs");
      logs.innerText += msg + "\n";
      logs.scrollTop = logs.scrollHeight;
      console.log(msg);
    }
    function isToday(dateString){
      try {
        const today = new Date();
        const saved = new Date(dateString);
        return today.toDateString() === saved.toDateString();
      } catch {
        return false;
      }
    }

    async function getLocation(){
      log("üìç R√©cup√©ration de la position...");
      return new Promise(resolve => {
        let resolved = false;
        const timer = setTimeout(() => {
          if (!resolved) {
            resolved = true;
            log("‚ö†Ô∏è Timeout ‚Üí fallback Paris");
            resolve({lat:48.8566, lon:2.3522});
          }
        }, 5000);

        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              if (!resolved) {
                resolved = true;
                clearTimeout(timer);
                log("‚úÖ Position r√©cup√©r√©e");
                resolve({lat: pos.coords.latitude, lon: pos.coords.longitude});
              }
            },
            () => {
              if (!resolved) {
                resolved = true;
                clearTimeout(timer);
                log("‚ö†Ô∏è Position refus√©e ‚Üí fallback Paris");
                resolve({lat:48.8566, lon:2.3522});
              }
            },
            {timeout: 4500}
          );
        } else {
          resolved = true;
          log("‚ö†Ô∏è G√©olocalisation non disponible ‚Üí fallback Paris");
          resolve({lat:48.8566, lon:2.3522});
        }
      });
    }

    async function getWeather(lat, lon){
      log("‚õÖ R√©cup√©ration de la m√©t√©o...");
      try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                    `&current_weather=true&hourly=temperature_2m,weathercode&forecast_days=1&timezone=Europe/Paris`;
        const res = await fetch(url);
        if (!res.ok) throw `API m√©t√©o erreur ${res.status}`;
        const data = await res.json();
        log("‚úÖ M√©t√©o r√©cup√©r√©e");
        return data;
      } catch(e) {
        log("‚ùå Erreur m√©t√©o : " + e);
        return null;
      }
    }

    async function getMistralNews(dateStr){
      log("üì∞ R√©cup√©ration des articles (Mistral)...");
      try {
        if (!MISTRAL_API_KEY) throw "‚ö†Ô∏è Cl√© API manquante";
        const prompt = `Pour chaque article ci-dessous, fais d'abord une recherche web sur les actualit√©s du ${dateStr} avant de r√©diger.` +
                       `G√©n√®re une gazette tech courte en fran√ßais. Sujets : korben, Raspberry Pi, ricing Linux, UXN, nouveaux PC/Mac, cyberdecks.` +
                       `Style clair et concis, 3 √† 5 articles. Cite les sources pour chaque news.`;

        const res = await fetch("https://api.mistral.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + MISTRAL_API_KEY
          },
          body: JSON.stringify({
            model: "mistral-medium",
            messages: [{role:"user", content:prompt}]
          })
        });

        if (!res.ok) throw `Erreur API Mistral: ${res.status}`;

        const data = await res.json();
        log("R√©ponse compl√®te API Mistral : " + JSON.stringify(data));

        if (data.choices && data.choices.length > 0) {
          if (data.choices[0].message && typeof data.choices[0].message.content === "string") {
            log("‚úÖ Articles r√©cup√©r√©s");
            return data.choices[0].message.content;
          } else if (typeof data.choices[0].text === "string") {
            log("‚úÖ Articles r√©cup√©r√©s (fallback text)");
            return data.choices[0].text;
          }
        }
        throw "R√©ponse Mistral invalide ou manquante";
      } catch(e) {
        log("‚ùå Erreur articles : " + e);
        return "‚ùå Pas d‚Äôarticles disponibles aujourd‚Äôhui.";
      }
    }

    function buildWeatherSection(weather) {
      if (!weather || !weather.current_weather || !weather.hourly || !Array.isArray(weather.hourly.time)) {
        return `<div class="section"><h2>M√©t√©o</h2><p>‚ùå Indisponible</p></div>`;
      }

      try {
        const current = weather.current_weather;
        const description = weatherCodes[current.weathercode] || "M√©t√©o inconnue";
        let html = `<div class="section"><h2>M√©t√©o</h2>
          <strong>Maintenant</strong> : üå°Ô∏è ${current.temperature}¬∞C&nbsp;&nbsp;üí® Vent: ${current.windspeed} km/h&nbsp;&nbsp;‚õÖ ${description}<br>
          <small>‚è∞ ${new Date(current.time).toLocaleTimeString("fr-FR")}</small>
          <h3 style="margin-top: 16px;">Pr√©visions aujourd'hui :</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 12px;">`;

        for (let i = 0; i < weather.hourly.time.length; i += 3) {
          const hourStr = new Date(weather.hourly.time[i]).toLocaleTimeString("fr-FR", {hour: "2-digit", minute: "2-digit"});
          const temp = weather.hourly.temperature_2m[i];
          const wcode = weather.hourly.weathercode[i];
          const desc = weatherCodes[wcode] || "?";
          html += `<div style="min-width: 90px; flex: 1 1 90px;">
            <strong>${hourStr}</strong><br/>
            ${temp}¬∞C<br/>
            ${desc}
          </div>`;
        }
        html += `</div></div>`;
        return html;

      } catch (err) {
        return `<div class="section"><h2>M√©t√©o</h2><p>‚ùå Erreur d'affichage m√©t√©o.</p></div>`;
      }
    }

    async function generateGazette() {
      try {
        // Affiche la date et r√©cup√®re la date format√©e pour prompt
        const dateStr = updateDateDisplay();

        document.getElementById("gazette").innerHTML = "‚è≥ G√©n√©ration en cours...";
        document.getElementById("logs").innerText = "";

        const loc = await getLocation();
        if (!loc.lat || !loc.lon) throw "Coordonn√©es manquantes";

        const weather = await getWeather(loc.lat, loc.lon);
        const news = await getMistralNews(dateStr);

        const meteoHtml = buildWeatherSection(weather);
        let formattedNews;
        try {
          formattedNews = marked.parse(news || "");
        } catch {
          formattedNews = `<div class="error">Erreur d'affichage des articles.</div>`;
        }

        const content = `${meteoHtml}<div class="section"><h2>Articles</h2>${formattedNews}</div>`;
        document.getElementById("gazette").innerHTML = content;

        localStorage.setItem("gazette", JSON.stringify({date: new Date(), content}));
        notifyUser("Nouvelle gazette disponible !");
      } catch(e) {
        document.getElementById("gazette").innerHTML = `<div class="section error">${e.toString()}</div>`;
      }
    }

    function notifyUser(msg) {
      if ("Notification" in window) {
        if (Notification.permission === "granted") {
          new Notification("Gazette", {body: msg});
        }
      }
    }

    async function init() {
      updateDateDisplay();
      if ("Notification" in window && Notification.permission !== "granted") {
        await Notification.requestPermission();
      }

      let saved = {};
      try {
        saved = JSON.parse(localStorage.getItem("gazette") || "{}");
      } catch {}

      if (saved.date && isToday(saved.date)) {
        document.getElementById("gazette").innerHTML = saved.content;
      } else {
        await generateGazette();
      }

      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 7 && now.getMinutes() === 0) generateGazette();
      }, 60000);
    }

    async function manualRefresh() {
      await generateGazette();
      alert("La gazette a √©t√© rafra√Æchie !");
    }

    window.addEventListener("DOMContentLoaded", () => { init(); });
  </script>
</body>
</html>
