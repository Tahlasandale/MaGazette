<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Feedback Quotidien</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Chargement global de Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* Reset & Base minimaliste */
    * { box-sizing: border-box; }
    
    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* Conteneur principal */
    .panel {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: normal;
      margin-bottom: 0.5rem;
      text-align: center;
      letter-spacing: -0.5px;
    }

    /* Liens discrets */
    .links {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      font-size: 0.85rem;
    }
    .links a {
      color: #666;
      text-decoration: none;
      transition: color 0.2s;
    }
    .links a:hover {
      color: #fff;
      text-decoration: underline;
    }

    /* Formulaire épuré */
    form {
      margin-bottom: 2rem;
    }

    label {
      display: block;
      margin: 0 0 0.5rem 0;
      color: #888;
      font-size: 0.85rem;
    }

    textarea, input[type="file"] {
      width: 100%;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      padding: 0.8rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    textarea:focus, input[type="file"]:focus {
      outline: none;
      border-color: #fff;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    input[type="file"] {
      padding: 0.6rem;
      font-size: 0.85rem;
      color: #888;
    }

    button {
      background: #fff;
      color: #000;
      border: 1px solid #fff;
      padding: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: opacity 0.2s;
    }
    
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Overlay de chargement pour n8n */
    #loader {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 2px solid #333;
      border-top: 2px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1.5rem;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .countdown-text {
      font-size: 1.2rem;
      font-weight: 300;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .sub-text {
      color: #666;
      font-size: 0.85rem;
    }

    /* Liste des feedbacks */
    .feedbacks { border-top: 1px solid #333; }

    .entry {
      border-bottom: 1px solid #333;
      padding: 1.5rem 0;
      position: relative;
    }

    .datetime {
      color: #444;
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
      font-family: monospace;
    }

    .entry-content { line-height: 1.5; color: #ddd; }
    .entry img { max-width: 100%; border-radius: 4px; border: 1px solid #333; margin-top: 0.5rem; }

    .entry-actions {
      position: absolute; top: 1.5rem; right: 0;
      display: none; gap: 0.5rem;
    }

    .entry:hover .entry-actions { display: flex; }

    .entry-action {
      background: #222; color: #fff; border: 1px solid #333;
      width: 28px; height: 28px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; padding: 0;
    }

    .entry-action:hover { background: #fff; color: #000; border-color: #fff; }

    .seeall, .hideall {
      background: transparent; color: #666; border: 1px solid #333;
      margin-top: 1.5rem; font-weight: normal; font-size: 0.85rem;
    }
    
    .seeall:hover, .hideall:hover { border-color: #666; color: #fff; opacity: 1; }

    @media (max-width: 480px) {
      body { padding: 1rem; }
      .entry-actions { display: flex; opacity: 0.5; }
    }
  </style>

  <script>
    const { createClient } = supabase;
    const SUPABASE_URL = "https://xcawojxvtxdcnwkhywmn.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjYXdvanh2dHhkY253a2h5d21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTI1MzMsImV4cCI6MjA3MjI4ODUzM30.gF46vM9cKso-hDKZODrqDwZOAhQGjPlHqPhBn9si9EI";
    const IMGBB_API_KEY = "78e05cd74f26e3e31a04ba7366739c98";

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    let feedbacks = [], showingAll = false, editingIndex = -1;

    function isImageUrl(content) {
      return typeof content === "string" && content.match(/^https?:\/\/.+\.(jpg|jpeg|png|webp)$/i);
    }

    async function loadFeedbacks(limit = 3) {
      let query = sb.from("Feedback").select("*").order("created_at", { ascending: false });
      if (!showingAll) query = query.limit(limit);
      
      const { data, error } = await query;
      if (error) return console.error("Erreur chargement:", error);
      feedbacks = data || [];
      render();
      
      document.getElementById("seeall").style.display = showingAll ? "none" : (feedbacks.length >= limit ? "block" : "none");
      document.getElementById("hideall").style.display = showingAll ? "block" : "none";
    }

    function render() {
      const box = document.getElementById("feedbacks");
      if (!feedbacks.length) {
        box.innerHTML = "<div style='color:#444; text-align:center; padding: 2rem 0;'>Aucun feedback pour le moment.</div>";
        return;
      }
      box.innerHTML = feedbacks.map((fb, index) => `
        <div class="entry" data-index="${index}">
          <div class="entry-actions">
            <button class="entry-action edit" onclick="editFeedback(${index})" title="Éditer">✎</button>
            <button class="entry-action delete" onclick="deleteFeedback(${index})" title="Supprimer">×</button>
          </div>
          <div class="datetime">${new Date(fb.created_at).toLocaleString('fr-FR')}</div>
          <div class="entry-content">
            ${isImageUrl(fb.content) ? `<img src="${fb.content}" loading="lazy">` : `<div>${fb.content.replace(/\n/g, "<br>")}</div>`}
          </div>
        </div>
      `).join("");
    }

    function showN8nLoader() {
      const loader = document.getElementById("loader");
      const countdownEl = document.getElementById("countdown");
      let timeLeft = 60;
      
      loader.style.display = "flex";
      countdownEl.innerText = timeLeft;

      const timer = setInterval(() => {
        timeLeft--;
        countdownEl.innerText = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timer);
          loader.style.display = "none";
          loadFeedbacks();
        }
      }, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("form").onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById("content").value.trim();
        const imageInput = document.getElementById("img").files[0];
        let content = text;
        const isTextOnly = !imageInput && text;

        if (imageInput) {
          try {
            content = await uploadImageToImgBB(imageInput);
          } catch (err) { alert(err.message); return; }
        } else if (!text) {
          alert("Entrez du texte ou une image."); return;
        }

        const table = imageInput ? "Feedback" : "text";
        const { error } = await sb.from(table).insert([{ content }]);

        if (error) {
          alert("Erreur: " + error.message);
        } else {
          document.getElementById("form").reset();
          if (isTextOnly) {
            // Si c'est du texte, on attend le traitement n8n
            showN8nLoader();
          } else {
            // Si c'est une image (pas de n8n), on rafraîchit direct
            loadFeedbacks();
          }
        }
      };

      async function uploadImageToImgBB(file) {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.readAsDataURL(file);
          reader.onload = async () => {
            const base64 = reader.result.split(',')[1];
            const formData = new FormData();
            formData.append("image", base64);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const data = await res.json();
            data.success ? resolve(data.data.url) : reject(new Error("Upload failed"));
          };
        });
      }

      document.getElementById("seeall").onclick = () => { showingAll = true; loadFeedbacks(); };
      document.getElementById("hideall").onclick = () => { showingAll = false; loadFeedbacks(); };
      loadFeedbacks();
    });
  </script>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <div class="countdown-text">Analyse en cours... <span id="countdown">60</span>s</div>
    <div class="sub-text">L'IA structure ton feedback quotidien.</div>
  </div>

  <div class="panel">
    <h1>Feedback Quotidien</h1>
    <div class="links">
      <a href="https://tahlasandale.github.io/MaGazette/SimpleTabHTML.html" target="_blank">SimpleTabHTML</a>
      <a href="https://chatgpt.com" target="_blank">ChatGPT</a>
    </div>

    <form id="form" autocomplete="off">
      <label for="content">NOUVEAU FEEDBACK</label>
      <textarea id="content" rows="3" placeholder="Comment s'est passée ta journée ?"></textarea>
      <label for="img">IMAGE (OPTIONNEL)</label>
      <input type="file" id="img" accept="image/png, image/jpeg, image/webp" />
      <button type="submit">Enregistrer</button>
    </form>

    <div class="feedbacks" id="feedbacks"></div>
    <button class="seeall" id="seeall" style="display: none">Voir plus</button>
    <button class="hideall" id="hideall" style="display: none">Voir moins</button>
  </div>
</body>
</html>
