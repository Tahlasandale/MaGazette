<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Feedback Minimaliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Chargement global de Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* Reset & Base minimaliste */
    * { box-sizing: border-box; }
    
    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* Conteneur principal */
    .panel {
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: normal;
      margin-bottom: 0.5rem;
      text-align: center;
      letter-spacing: -0.5px;
    }

    /* Liens discrets */
    .links {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 2rem;
      font-size: 0.85rem;
    }
    .links a {
      color: #666;
      text-decoration: none;
      transition: color 0.2s;
    }
    .links a:hover {
      color: #fff;
      text-decoration: underline;
    }

    /* Formulaire épuré */
    form {
      margin-bottom: 2rem;
    }

    label {
      display: block;
      margin: 0 0 0.5rem 0;
      color: #888;
      font-size: 0.85rem;
    }

    textarea, input[type="file"] {
      width: 100%;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      padding: 0.8rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    textarea:focus, input[type="file"]:focus {
      outline: none;
      border-color: #fff;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* Input file style hack pour rester minimaliste */
    input[type="file"] {
      padding: 0.6rem;
      font-size: 0.85rem;
      color: #888;
    }

    button {
      background: #fff;
      color: #000;
      border: 1px solid #fff;
      padding: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      border-radius: 4px;
      font-size: 0.95rem;
      transition: opacity 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
    }

    /* Liste des feedbacks */
    .feedbacks {
      border-top: 1px solid #333;
    }

    .entry {
      border-bottom: 1px solid #333;
      padding: 1.5rem 0;
      position: relative;
    }

    .datetime {
      color: #444;
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
      font-family: monospace;
    }

    .entry-content {
      line-height: 1.5;
      color: #ddd;
    }

    .entry img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #333;
      margin-top: 0.5rem;
    }

    /* Actions (Edit/Delete) - Apparaissent au survol comme sur la todo list */
    .entry-actions {
      position: absolute;
      top: 1.5rem;
      right: 0;
      display: none;
      gap: 0.5rem;
    }

    .entry:hover .entry-actions {
      display: flex;
    }

    .entry-action {
      background: #222;
      color: #fff;
      border: 1px solid #333;
      width: 28px;
      height: 28px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      padding: 0;
    }

    .entry-action:hover {
      background: #fff;
      color: #000;
      border-color: #fff;
    }

    /* Boutons Voir tout / Masquer */
    .seeall, .hideall {
      background: transparent;
      color: #666;
      border: 1px solid #333;
      margin-top: 1.5rem;
      font-weight: normal;
      font-size: 0.85rem;
    }
    
    .seeall:hover, .hideall:hover {
      border-color: #666;
      color: #fff;
      opacity: 1;
    }

    @media (max-width: 480px) {
      body { padding: 1rem; }
      .entry-actions { display: flex; opacity: 0.5; } /* Toujours visible sur mobile */
    }
  </style>

  <script>
    // Récupération du client Supabase global
    const { createClient } = supabase;

    // Configuration
    const SUPABASE_URL = "https://xcawojxvtxdcnwkhywmn.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjYXdvanh2dHhkY253a2h5d21uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTI1MzMsImV4cCI6MjA3MjI4ODUzM30.gF46vM9cKso-hDKZODrqDwZOAhQGjPlHqPhBn9si9EI";
    const IMGBB_API_KEY = "78e05cd74f26e3e31a04ba7366739c98";

    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    let feedbacks = [], showingAll = false, editingIndex = -1;

    function isImageUrl(content) {
      return typeof content === "string" && content.match(/^https?:\/\/.+\.(jpg|jpeg|png|webp)$/i);
    }

    async function loadFeedbacks(limit = 3) {
      // CORRECTION : On cible la table principale 'Feedback' (Majuscule Singulier) pour l'affichage
      let query = sb
        .from("Feedback")
        .select("*")
        .order("created_at", { ascending: false });
      
      if (!showingAll) query = query.limit(limit);
      
      const { data, error } = await query;
      if (error) {
        console.error("Erreur chargement:", error);
        return;
      }
      feedbacks = data || [];
      render();
      
      // Gestion visibilité boutons
      const seeAllBtn = document.getElementById("seeall");
      const hideAllBtn = document.getElementById("hideall");
      
      if(seeAllBtn) seeAllBtn.style.display = showingAll ? "none" : (feedbacks.length === limit ? "block" : "none");
      if(hideAllBtn) hideAllBtn.style.display = showingAll ? "block" : "none";
    }

    function render() {
      const box = document.getElementById("feedbacks");
      if (!feedbacks.length) {
        box.innerHTML = "<div style='color:#444; text-align:center; padding: 2rem 0;'>Aucun feedback pour le moment.</div>";
        return;
      }
      box.innerHTML = feedbacks
        .map(
          (fb, index) => `
        <div class="entry" data-index="${index}">
          <div class="entry-actions">
            <button class="entry-action edit" onclick="editFeedback(${index})" title="Éditer">✎</button>
            <button class="entry-action delete" onclick="deleteFeedback(${index})" title="Supprimer">×</button>
          </div>
          <div class="datetime">${new Date(fb.created_at).toLocaleString('fr-FR')}</div>
          <div class="entry-content">
          ${
            isImageUrl(fb.content)
              ? `<img src="${fb.content}" alt="Feedback image" loading="lazy">`
              : `<div>${fb.content.replace(/\n/g, "<br>")}</div>`
          }
          </div>
        </div>
      `
        )
        .join("");
    }

    window.editFeedback = async function(index) {
      const feedback = feedbacks[index];
      editingIndex = index;

      if (isImageUrl(feedback.content)) {
        alert("L'édition d'images n'est pas encore supportée. Supprimez et recréez.");
        editingIndex = -1;
        return;
      }

      document.getElementById("content").value = feedback.content.replace(/<br>/g, "\n");
      document.getElementById("content").focus();

      const submitBtn = document.querySelector("#form button[type='submit']");
      submitBtn.textContent = "Mettre à jour";

      document.addEventListener("click", cancelEditOnClickOutside);
    }

    function cancelEditOnClickOutside(e) {
      if (!e.target.closest("#form") && !e.target.closest(".entry")) {
        cancelEdit();
      }
    }

    function cancelEdit() {
      editingIndex = -1;
      document.getElementById("content").value = "";
      document.getElementById("img").value = "";
      const submitBtn = document.querySelector("#form button[type='submit']");
      if(submitBtn) submitBtn.textContent = "Enregistrer";
      document.removeEventListener("click", cancelEditOnClickOutside);
    }

    window.deleteFeedback = async function(index) {
      if (!confirm("Supprimer ce feedback ?")) return;

      const feedback = feedbacks[index];
      try {
        // CORRECTION : Suppression explicite dans la table 'Feedback'
        let deleteQuery = sb.from("Feedback").delete();

        if (feedback.id !== undefined && feedback.id !== null) {
          deleteQuery = deleteQuery.eq("id", feedback.id);
        } else {
          const createdAtISO = new Date(feedback.created_at).toISOString();
          deleteQuery = deleteQuery.eq("created_at", createdAtISO).eq("content", feedback.content);
        }

        const { error } = await deleteQuery;
        if (error) throw error;
        loadFeedbacks();
      } catch (error) {
        console.error("Erreur suppression:", error);
        alert("Erreur lors de la suppression : " + error.message);
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }

    async function uploadImageToImgBB(file) {
      const base64Image = await toBase64(file);
      const formData = new FormData();
      formData.append("image", base64Image);

      const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
        method: "POST",
        body: formData,
      });

      if (!response.ok) throw new Error("Erreur upload ImgBB");
      const data = await response.json();
      if (!data.success) throw new Error("Erreur upload ImgBB");

      return data.data.url;
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("form").onsubmit = async (e) => {
        e.preventDefault();
        const text = document.getElementById("content").value.trim();
        const imageInput = document.getElementById("img").files[0];
        let content = text;

        // Gestion de l'upload image
        if (imageInput) {
          try {
            content = await uploadImageToImgBB(imageInput);
          } catch (err) {
            alert("Erreur upload image : " + err.message);
            return;
          }
        } else if (!text) {
          alert("Veuillez entrer du texte ou choisir une image.");
          return;
        }

        if (editingIndex >= 0) {
          // Mode édition : Update sur 'Feedback'
          const feedback = feedbacks[editingIndex];
          try {
            let updateQuery = sb.from("Feedback").update({ content });

            if (feedback.id !== undefined && feedback.id !== null) {
              updateQuery = updateQuery.eq("id", feedback.id);
            } else {
              const createdAtISO = new Date(feedback.created_at).toISOString();
              updateQuery = updateQuery.eq("created_at", createdAtISO).eq("content", feedback.content);
            }

            const { error } = await updateQuery;
            if (error) throw error;
          } catch (error) {
            console.error("Erreur mise à jour:", error);
            alert("Erreur mise à jour");
            return;
          }
        } else {
          // Mode ajout
          let error;
          
          if (imageInput) {
            // IMAGE -> Table 'Feedback'
            const res = await sb.from("Feedback").insert([{ content }]); 
            error = res.error;
          } else {
            // TEXTE -> Table 'text' (Spécifique, mais attention : ils ne seront pas visibles si on ne charge que 'Feedback')
            const res = await sb.from("text").insert([{ content }]);
            error = res.error;
          }

          if (error) {
            console.error("Erreur ajout:", error);
            alert("Erreur ajout: " + error.message);
            return;
          }
        }

        document.getElementById("form").reset();
        cancelEdit();
        showingAll = false;
        loadFeedbacks();
      };

      const seeAllBtn = document.getElementById("seeall");
      const hideAllBtn = document.getElementById("hideall");

      if(seeAllBtn) seeAllBtn.onclick = () => {
        showingAll = true;
        loadFeedbacks();
      };
      if(hideAllBtn) hideAllBtn.onclick = () => {
        showingAll = false;
        loadFeedbacks();
      };
      
      loadFeedbacks();
    });
  </script>
</head>
<body>
  <div class="panel">
    <h1>Feedback Quotidien</h1>
    
    <div class="links">
      <a href="https://tahlasandale.github.io/MaGazette/SimpleTabHTML.html" target="_blank">SimpleTabHTML</a>
      <a href="https://chatgpt.com" target="_blank">ChatGPT</a>
    </div>

    <form id="form" autocomplete="off">
      <label for="content">NOUVEAU FEEDBACK</label>
      <textarea id="content" rows="3" placeholder="Comment s'est passée ta journée ?"></textarea>
      
      <label for="img">IMAGE (OPTIONNEL)</label>
      <input type="file" id="img" accept="image/png, image/jpeg, image/webp" />
      
      <button type="submit">Enregistrer</button>
    </form>

    <div class="feedbacks" id="feedbacks"></div>
    <button class="seeall" id="seeall" style="display: none">Voir plus</button>
    <button class="hideall" id="hideall" style="display: none">Voir moins</button>
  </div>
</body>
</html>