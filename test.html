<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma Gazette Retro</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: "MS Sans Serif", Tahoma, Geneva, sans-serif;
      background: #008080;
      color: #000;
    }

    h1 {
      font-size: 1.8em;
      background: #000080;
      color: #fff;
      padding: 5px 10px;
      border: 2px solid #fff;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    button {
      font-family: "MS Sans Serif", Tahoma, Geneva, sans-serif;
      font-weight: bold;
      border: 2px outset #fff;
      background: #c0c0c0;
      color: #000;
      padding: 3px 8px;
      cursor: pointer;
    }

    button:active {
      border-style: inset;
    }

    .section {
      background: #c0c0c0;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #fff;
    }

    .section h2 {
      font-size: 1.2em;
      margin: 0 0 5px 0;
      text-decoration: underline;
    }

    .logs {
      font-size: 0.9em;
      font-family: monospace;
      white-space: pre-line;
      margin-top: 10px;
      background: #fff;
      padding: 5px;
      border: 2px inset #000;
      max-height: 200px;
      overflow-y: auto;
    }

    .error {
      color: red;
      font-weight: bold;
    }

    em { font-style: italic; }
    strong { font-weight: bold; }
    a { color: #000080; text-decoration: underline; }

    @media (max-width: 600px) {
      h1 { font-size: 1.4em; }
      .section { padding: 5px; }
    }
  </style>
  <!-- Librairie Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>
    üì¨ Ma Gazette du Jour
    <button onclick="manualRefresh()">üîÑ Rafra√Æchir</button>
  </h1>

  <div id="gazette">Chargement...</div>
  <div id="logs" class="logs"></div>

  <script>
    const MISTRAL_API_KEY = "4TkJgrGZ19tSwyrRPqYUqgAZh4ttCKmc";
    const weatherCodes = {0:"Ciel clair",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",61:"Pluie faible",95:"Orages"};

    function log(msg){document.getElementById("logs").innerText+=msg+"\n";console.log(msg);}
    function isToday(dateString){const today=new Date();const saved=new Date(dateString);return today.toDateString()===saved.toDateString();}

    async function getLocation(){
      log("üìç R√©cup√©ration de la position...");
      return new Promise(resolve=>{
        let resolved=false;
        const timer=setTimeout(()=>{
          if(!resolved){resolved=true;log("‚ö†Ô∏è Timeout ‚Üí fallback Paris");resolve({lat:48.8566,lon:2.3522});}
        },5000);
        navigator.geolocation.getCurrentPosition(
          pos=>{if(!resolved){resolved=true;clearTimeout(timer);log("‚úÖ Position r√©cup√©r√©e");resolve({lat:pos.coords.latitude,lon:pos.coords.longitude});}},
          ()=>{if(!resolved){resolved=true;clearTimeout(timer);log("‚ö†Ô∏è Position refus√©e ‚Üí fallback Paris");resolve({lat:48.8566,lon:2.3522});}}
        );
      });
    }

    async function getWeather(lat,lon){
      log("‚õÖ R√©cup√©ration de la m√©t√©o...");
      try{
        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
        const data = await res.json();
        log("‚úÖ M√©t√©o r√©cup√©r√©e");
        return data.current_weather;
      }catch(e){log("‚ùå Erreur m√©t√©o");return null;}
    }

    async function getMistralNews(){
      log("üì∞ R√©cup√©ration des articles (Mistral)...");
      try{
        if(!MISTRAL_API_KEY)throw "‚ö†Ô∏è Cl√© API manquante";
        const controller=new AbortController();
        const timeout=setTimeout(()=>controller.abort(),30000);
        const res=await fetch("https://api.mistral.ai/v1/chat/completions",{
          method:"POST",
          headers:{"Content-Type":"application/json","Authorization":"Bearer "+MISTRAL_API_KEY},
          body:JSON.stringify({model:"mistral-medium",messages:[{role:"user",content:`G√©n√®re une courte gazette tech du jour en fran√ßais. Sujets : korben, Raspberry Pi, ricing Linux, UXN, nouveaux PC/Mac, cyberdecks. Style clair et concis, avec 3-5 articles.`}]}),
          signal:controller.signal
        });
        clearTimeout(timeout);
        if(!res.ok)throw "Erreur API Mistral: "+await res.text();
        const data=await res.json();
        log("‚úÖ Articles r√©cup√©r√©s");
        return data.choices[0].message.content;
      }catch(e){log("‚ùå Erreur articles : "+e);return "‚ùå Pas d‚Äôarticles disponibles aujourd‚Äôhui.";}
    }

    async function generateGazette(){
      try{
        document.getElementById("gazette").innerHTML="‚è≥ G√©n√©ration en cours...";
        document.getElementById("logs").innerText="";

        const loc = await getLocation();
        const weather = await getWeather(loc.lat, loc.lon);
        const news = await getMistralNews();

        let meteoHtml=`<div class="section"><h2>M√©t√©o</h2>‚ùå Indisponible</div>`;
        if(weather){
          const description = weatherCodes[weather.weathercode] || "M√©t√©o inconnue";
          meteoHtml = `<div class="section"><h2>M√©t√©o</h2>
            üå°Ô∏è ${weather.temperature}¬∞C<br>
            üí® Vent: ${weather.windspeed} km/h<br>
            ‚õÖ ${description}<br>
            ‚è∞ ${new Date(weather.time).toLocaleTimeString("fr-FR")}
          </div>`;
        }

        // Parser Markdown complet avec marked.js
        const formattedNews = marked.parse(news);

        const content=`${meteoHtml}<div class="section"><h2>Articles</h2>${formattedNews}</div>`;
        document.getElementById("gazette").innerHTML = content;
        localStorage.setItem("gazette",JSON.stringify({date:new Date(),content}));
        notifyUser("Nouvelle gazette disponible !");
      }catch(e){document.getElementById("gazette").innerHTML=`<div class="error">${e}</div>`;}
    }

    function notifyUser(msg){if(Notification.permission==="granted")new Notification("Gazette",{body:msg});}

    async function init(){
      if(Notification.permission!=="granted")await Notification.requestPermission();
      const saved=JSON.parse(localStorage.getItem("gazette")||"{}");
      if(saved.date && isToday(saved.date)){document.getElementById("gazette").innerHTML=saved.content;}
      else await generateGazette();

      setInterval(()=>{
        const now = new Date();
        if(now.getHours()===7 && now.getMinutes()===0) generateGazette();
      },60000);
    }

    async function manualRefresh(){await generateGazette();alert("La gazette a √©t√© rafra√Æchie !");}
    init();
  </script>
</body>
</html>