    }
                this.tasks = this.tasks.filter(t => t.id !== id);
                if (this.currentTaskIndex > index) {
                    this.currentTaskIndex--;
                }
                this.saveToStorage();
                this.renderTasks();
            }

            start() {
                if (this.isPaused) {
                    this.isPaused = false;
                    this.startTimer();
                    return;
                }

                if (this.currentTaskIndex === -1) {
                    this.currentTaskIndex = 0;
                }

                if (this.currentTaskIndex >= this.tasks.length) {
                    this.showToast('Termin√©', 'Toutes les t√¢ches sont compl√©t√©es !');
                    this.reset();
                    return;
                }

                const task = this.tasks[this.currentTaskIndex];
                task.status = 'in-progress';
                
                this.startTimer();
                this.renderTasks();
            }

            startTimer() {
                const task = this.tasks[this.currentTaskIndex];
                this.targetTimestamp = Date.now() + (task.remainingSec * 1000);
                
                this.startBtn.disabled = true;
                this.pauseBtn.disabled = false;
                this.stopBtn.disabled = false;

                this.updateActiveTaskDisplay();
                
                this.timerInterval = setInterval(() => this.tick(), 1000);
                this.tick();
            }

            tick() {
                const task = this.tasks[this.currentTaskIndex];
                const remaining = Math.max(0, Math.round((this.targetTimestamp - Date.now()) / 1000));
                
                task.remainingSec = remaining;
                
                this.updateTimerDisplay(remaining);
                this.updateProgress();

                if (remaining <= 0) {
                    this.completeTask();
                }
            }

            pause() {
                this.isPaused = true;
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
            }

            stop() {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                this.isPaused = false;
                
                if (this.currentTaskIndex !== -1) {
                    const task = this.tasks[this.currentTaskIndex];
                    task.status = 'pending';
                    task.remainingSec = task.durationSec;
                }
                
                this.startBtn.disabled = false;
                this.pauseBtn.disabled = true;
                this.stopBtn.disabled = true;
                
                this.taskStatusEl.textContent = 'Aucune t√¢che';
                this.activeTaskTitleEl.textContent = 'Pr√™t √† commencer';
                this.timerDisplayEl.textContent = '00:00';
                this.progressFillEl.style.width = '0%';
                
                this.renderTasks();
                this.saveToStorage();
            }

            completeTask() {
                const task = this.tasks[this.currentTaskIndex];
                task.status = 'completed';
                
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                
                this.playSound();
                this.showNotification(task.title);
                this.showToast('T√¢che termin√©e', task.title);
                
                this.tasks.splice(this.currentTaskIndex, 1);
                
                if (this.tasks.length === 0) {
                    this.reset();
                    this.showToast('Bravo !', 'Toutes les t√¢ches sont termin√©es !');
                    return;
                }
                
                if (this.settings.autoStartNext) {
                    setTimeout(() => {
                        this.currentTaskIndex = 0;
                        this.start();
                    }, 1000);
                } else {
                    this.currentTaskIndex = 0;
                    this.stop();
                }
                
                this.saveToStorage();
                this.renderTasks();
            }

            reset() {
                this.currentTaskIndex = -1;
                this.stop();
            }

            updateActiveTaskDisplay() {
                const task = this.tasks[this.currentTaskIndex];
                this.taskStatusEl.textContent = 'En cours';
                this.activeTaskTitleEl.textContent = task.title;
            }

            updateTimerDisplay(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                this.timerDisplayEl.textContent = 
                    `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            updateProgress() {
                const task = this.tasks[this.currentTaskIndex];
                const progress = ((task.durationSec - task.remainingSec) / task.durationSec) * 100;
                this.progressFillEl.style.width = `${progress}%`;
            }

            playSound() {
                if (this.settings.soundEnabled) {
                    this.audio.play().catch(e => console.log('Audio play failed:', e));
                }
            }

            showNotification(taskTitle) {
                if (this.settings.notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification('T√¢che termin√©e', {
                        body: taskTitle,
                        icon: 'üéâ'
                    });
                }
            }

            showToast(title, message) {
                this.toastTitleEl.textContent = title;
                this.toastMessageEl.textContent = message;
                this.toastEl.classList.add('show');
                
                setTimeout(() => {
                    this.toastEl.classList.remove('show');
                }, 3000);
            }

            toggleSound() {
                this.settings.soundEnabled = !this.settings.soundEnabled;
                this.soundToggle.classList.toggle('active');
                this.saveToStorage();
            }

            toggleAutoStart() {
                this.settings.autoStartNext = !this.settings.autoStartNext;
                this.autoStartToggle.classList.toggle('active');
                this.saveToStorage();
            }

            async requestNotificationPermission() {
                if (!('Notification' in window)) {
                    this.showToast('Non support√©', 'Les notifications ne sont pas support√©es par votre navigateur');
                    return;
                }

                if (Notification.permission === 'granted') {
                    this.settings.notificationsEnabled = !this.settings.notificationsEnabled;
                    this.notifToggle.classList.toggle('active');
                    this.saveToStorage();
                    return;
                }

                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    this.settings.notificationsEnabled = true;
                    this.notifToggle.classList.add('active');
                    this.showToast('Activ√©', 'Les notifications sont maintenant activ√©es');
                    this.saveToStorage();
                } else {
                    this.showToast('Permission refus√©e', 'Activez les notifications dans les param√®tres du navigateur');
                }
            }

            saveToStorage() {
                const data = {
                    tasks: this.tasks,
                    settings: this.settings
                };
                localStorage.setItem('sunset-timer.data', JSON.stringify(data));
            }

            loadFromStorage() {
                const stored = localStorage.getItem('sunset-timer.data');
                if (stored) {
                    const data = JSON.parse(stored);
                    this.tasks = data.tasks || [];
                    this.settings = { ...this.settings, ...data.settings };
                    
                    if (this.settings.soundEnabled) {
                        this.soundToggle.classList.add('active');
                    }
                    if (this.settings.autoStartNext) {
                        this.autoStartToggle.classList.add('active');
                    }
                    if (this.settings.notificationsEnabled) {
                        this.notifToggle.classList.add('active');
                    }
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        const app = new SunsetTimer();
